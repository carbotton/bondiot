<!DOCTYPE HTML>
<!--
	Solid State by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>

<head>
	<title>Thingsboard - BondIoT</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<link rel="stylesheet" href="assets/css/main.css" />
	<noscript>
		<link rel="stylesheet" href="assets/css/noscript.css" />
	</noscript>
	<link rel="shortcut icon" href="images/logo-green-bus.png" type="image/vnd.microsoft.icon"> <!-- majo: agrega icono a la pestaña -->
</head>

<body class="is-preload">

	<!-- Page Wrapper -->
	<div id="page-wrapper">

		<!-- Header -->
		<div id="page-wrapper">

			<!-- Header -->
				<header id="header">
					<h1><a href="thingsboard-doc.html">Proceso</a></h1>
					<nav>
						<a href="#menu">Menu</a>
					</nav>
				</header>

		<!-- Menu -->
		<nav id="menu">
			<div class="inner">
				<h2>Menu</h2>
				<ul class="links">
					<li><a href="index.html">Home</a></li>
					<li><a href="idea.html">Idea</a></li>
					<li><a href="proceso.html">Proceso</a></li>
					<li><a href="thingsboard-doc.html">Documentación de ThingsBoard</a></li>
					<li><a href="resultado/dist/resultado.html">Resultado</a></li>	
				</ul>
				<a href="#" class="close">Close</a>
			</div>
		</nav>

		<!-- Banner -->
		<section id="banner">
			<div class="inner">
				<h2 class="title">Documentación de Thingsboard</h2>
				<p>En esta sección se documentará todo lo hecho en ThingsBoard para facilitar la reproducción del proyecto. Todo el proyecto fue hecho en la versión  <a href="https://demo.thingsboard.io/" style="color: rgb(134, 168, 235)">demo de Thingsboard</a>.</p>
				<div class="inner"> <button type="button"><a href="https://demo.thingsboard.io/dashboard/f656ce70-1ff7-11ec-b4a5-cfb289af38d9?publicId=c783dd50-1ff1-11ec-b4a5-cfb289af38d9" target="_blank">Ir al dashboard del proyecto</a></button></div>
			</div>
		</section>

		<!-- Wrapper -->
		<section id="wrapper">
			<section id="contenido" class="wrapper spotlight style3">
				<div class="inner">
					<div class="content">
						
						<h3 class="major">Índice</h3>
						<div class="table-wrapper">
							<table>
								<thead>
									<tr>
										<th>Tema</th>
										<th>Subtema</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td>Dashboard</td>
										<td><a href="#dashboard_1">Default dashboard</a></td>
									</tr>
									<tr>
										<td></td>
										<td><a href="#dashboard_2">Dashboard de Set Up</a></td>
									</tr>
									<tr>
										<td></td>
										<td><a href="#dashboard_3">Dashboard de Debug</a></td>
									</tr>									
									<tr>
										<td>Devices</td>
										<td><a href="#device_1"></a>Creación de Entity View y Alias</td>
									</tr>
									<tr>
										<td></td>
										<td><a href="#device_2">Creación de Device y Device profile</a></td>
									</tr>	
									<tr>
										<td></td>
										<td><a href="#device_3">Assets</a></td>
									</tr>																		
									<tr>
										<td>Rule chains</td>
										<td><a href="#rule_1">Root rule</a></td>
									<tr>
										<td></td>
										<td><a href="#rule_2">CO2 rule</a></td>
									</tr>
									<tr>
										<td></td>
										<td><a href="#rule_3">Load cell rule</a></td>
									</tr>	
									<tr>
										<td></td>
										<td><a href="#rule_4">MAC address rule</a></td>
									</tr>																
									<tr>
										<td></td>
										<td><a href="#rule_5">Total passengers rule</a></td>
									</tr>	
									<tr>
										<td></td>
										<td><a href="#rule_6">Full bus rule</a></td>
									</tr>	
									<tr>
										<td></td>
										<td><a href="#rule_7">Doors rule</a></td>
									</tr>	
									<tr>
										<td></td>
										<td><a href="#rule_8">Asset rule</a></td>
									</tr>																									
								</tbody>
							</table>
						</div>
												
						<section>

							<h2 id="dashboard_1" style="background:#2f3647; text-align:center">Default dashboard</h2>
							<p>El default dashboard es el que se utilizará para mostrar datos en tiempo real y widgets de control, como ser el switch que abre o cierra la escotilla manualmente.</p>	
							<p>El dashboard puede ser importado desde el repositorio del proyecto.</p>
							<img src="./files/thingsboard/dash_default.png" style="width:60%;height:50%">
							<p><br></p>

							<h2 id="dashboard_2" style="background:#2f3647; text-align:center">Dashboard de Set up</h2>
							<p>Para la modificación de parámetros fijos como el peso estándar de un pasajero o el nivel máximo de CO2 permitido, se creó el dashboard de setup.</p>		
							<p>El dashboard puede ser importado desde el repositorio del proyecto.</p>
							<img src="./files/thingsboard/dash_setup.png" style="width:60%;height:50%">						
							<p><br></p>

							<h2 id="dashboard_3" style="background:#2f3647; text-align:center">Dashboard de Debug</h2>	
							<p>Este dashboard fue creado para facilitar la detección de errores en el funcionamiento del sistema, ya que se pueden ver todos los atributos y telemetría de los dispositivos.</p>
							<p>El dashboard puede ser importado desde el repositorio del proyecto.</p>
							<img src="./files/thingsboard/dash_debug.png" style="width:60%;height:50%">						
							<p><br></p>

							<h2 id="device_1" style="background:#2f3647; text-align:center">Creación de Entity View y Alias</h2>
							<img src="./files/thingsboard/entityview.png" style="width:60%;height:50%" />
							<img src="./files/thingsboard/entityview-conf.png" style="width:60%;height:50%" />
							<p>El entity view es a veces utilizado para elegir de donde vienen los datos a mostrar en los widgets del dashboard. Notar que acá también hay que setear para que sea público.</p>	
							<p>El alias se crea dentro del widget cuando se requiere, el nombre que se le dio para este proyecto es: BondIoT-ESP8266-AliasDevice pero podría variar sin problemas.</p>

							<h2 id="device_2" style="background:#2f3647; text-align:center">Creación de Device y Device profile</h2>
							<img src="./files/thingsboard/device.png" style="width:60%;height:50%" />
							<img src="./files/thingsboard/device-att-s.png" style="width:60%;height:50%" />
							<p>
								<ul>
									<li>Nombre del device: BondIoT-ESP8266-Dev</li>
									<li>Tiene que ser público para poder ser visualizado en el dashboard por cualquiera que no sea dueño del dashboard.</li>
									<li>En la pestaña Attributes se agregaron los atributos, en la imagen se muestran algunos atributos de servidor. Es importante mantener los nombres como aquí se muestra para que funcionen las Rule Chains y Widgets que dependen de estos atributos.
										<br><br>
										<h5>Los atributos agregados son:</h5>
										<h6>Server attributes:</h6>
											<ul>
												<li>alarmStateCO2</li>
												<li>co2</li>
												<li>doors</li>
												<li>loadcell</li>
												<li>maxCO2</li>
												<li>maxPassengers</li>
												<li>nPassengers</li>
												<li>standardWeight</li>
											</ul>
										<h6>Client attributes:</h6>
											<ul>
												<li>ledStatus</li>
											</ul>
										<h6>Shared attributes:</h6>
											<ul>
												<li>calibrationModeLoadCell</li>
												<li>weightForCalibration</li>
											</ul>
									</li>
								</ul>
							
							</p>
							<p>
								El perfil del device en este caso lo dejamos en el default, sin definir nada en particular.
							</p>

							<h2 id="device_3" style="background:#2f3647; text-align:center">Assets</h2>
							<p>La creación del asset es necesaria para poder combinar los datos de los dos devices del sistema. Esta combinación se refleja con una relación definida en el asset y se implementa en la rule chain BondIoT-ESP8266-Asset_Rule. </p>
							<img src="./files/thingsboard/asset1.png" style="width:60%;height:50%" />

							<img src="./files/thingsboard/asset2.png" style="width:60%;height:50%" />
							<p>El Asset type puede ser cualquiera a los efectos de este proyecto, en este caso se llama igual que el Asset y se define en el momento de creación, en la misma ventana.</p>
							<img src="./files/thingsboard/asset3.png" style="width:60%;height:50%" />
							<img src="./files/thingsboard/asset4.png" style="width:60%;height:50%" />
							<p>Para que la rule chain funcione las relaciones se crean como se muestra en la imagen. La dirección es FROM y se agrega una por cada device involucrado.</p>
														

							<h2 style="background:#2f3647; text-align:center">Rule chains</h2>

							<h3 id="rule_1" style="border:3px; border-style:solid; border-color:#2f3647; padding: 1em;; text-align:center">Root rule</h4>
							<p>Nombre de la regla: BondIoT-ESP8266-RootRule</p>
							<p>Esta rule chain puede ser importada del repositorio en Github.</p>
							<p>Esta es la rule chain que maneja los llamados a todas las demás rule chains del sistema.</p>
							<img src="./files/thingsboard/rule_root.png" style="width:60%;height:50%" />
							<p><br></p>

							<h3 id="rule_2" style="border:3px; border-style:solid; border-color:#2f3647; padding: 1em;; text-align:center">CO2 rule</h4>
							<p>Nombre de la rule chain: BondIoT-ESP8266-C02Thresh</p>
							<p>Esta rule chain puede ser importada del repositorio en Github.</p>
							<p>Flujo:</p>
							<ol>
								<li>Agregar a la metadata el atributo shared alarmCO2 y el atributo de servidor maxCO2</li>
								<li>Verificar si la telemetría recibida de CO2 supera el máximo permitido </li>
								<li>Si lo supera, alarmCO2 = TRUE. Si no lo supera, alarmCO2 = FALSE.</li>
								<li>Se guarda el atributo.</li>
							</ol>
							<img src="./files/thingsboard/rule_co2.png" style="width:60%;height:50%" />
							<p><br></p>

							<h3 id="rule_3" style="border:3px; border-style:solid; border-color:#2f3647; padding: 1em;; text-align:center">Load cell rule</h4>
							<p>Nombre de la rulechain: BondIoT-ESP8266-Passengers_by_weight</p>
							<p>Esta rule chain puede ser importada del repositorio en Github.</p>
							<p>Flujo:</p>
							<ol>
								<li>Agregar a la metadata los atributos de servidor: standardWeight y passengersLoadcell</li>
								<li>La telemetría recibida de la celda de carga se divide entre el peso estándar de un pasajero para obtener la cantidad de personas abordo. El resultado se guarda en  passengersLoadcell</li>
								<li>Se guarda el atributo.</li>
							</ol>
							<img src="./files/thingsboard/rule_loadcell.png" style="width:60%;height:50%" />
							<p><br></p>							

							<h3 id="rule_4" style="border:3px; border-style:solid; border-color:#2f3647; padding: 1em;; text-align:center">MAC address rule</h4>
							<p>En este caso tenemos dos rule chain que se encargan de manejar las MAC. </p>
							<p>Nombre de la rulechain: BondIoT-ESP8266-Passengers_MAC</p>
							<img src="./files/thingsboard/rule_passmac.png" style="width:60%;height:50%" />
							<p>Se recibe en esta rule chain desde el ESP8266-01 una cadena de direcciones MAC delimitadas por dos strings: "New reading" y "End of reading". Cuando llega un "New reading" la rule chain reinicia el contador, cuando llega un "End of reading" se termina de contar y se guarda el resultado en un atributo. Mientras se está en el estado intermedio se consume la API por cada dirección MAC que haya llegado.<br></p>
							<p>Nombre de la rulechain: BondIoT-ESP8266-Mac_vendors_API</p>
							<img src="./files/thingsboard/rule_apimac.png" style="width:60%;height:50%" />
							<p>El input de esta rule chain es una única dirección MAC. Esta dirección se pasa como parámetro al bloque naranja que se encarga de consumir la API de macvendors.co. El primer script verifica en el cuerpo del response si la dirección MAC corresponde con un fabricante, es decir, es una dirección real de un teléfono conectado a la red del ómnibus. En caso de ser así, se suma 1 al contador de pasajeros y se guarda el atributo.</p>

							<h3 id="rule_5" style="border:3px; border-style:solid; border-color:#2f3647; padding: 1em;; text-align:center">Total passengers rule</h4>
							<p>Nombre de la rulechain: BondIoT-ESP8266-Total_Passengers</p>	
							<p>Esta rule chain confirma que los datos de pasajeros sean coherentes y no nulos y procede a hacer un promedio con aquellos datos que sean correctos. Este promedio nos da el número total de pasajeros a bordo del sistema y es con este atributo que se maneja si el ómnibus va o no lleno.</p>

							<h3 id="rule_6" style="border:3px; border-style:solid; border-color:#2f3647; padding: 1em;; text-align:center">Full bus rule</h4>
							<p>Nombre de la rulechain: BondIoT-ESP8266-Notify_full_bus</p>	
							<p>Esta rule chain puede ser importada del repositorio en Github.</p>
							<p>Flujo:</p>
							<ol>
								<li>Agregar a la metadata el atributo shared reachedMaxPass y los atributos de servidor passengersTOTAL y maxPassengers</li>
								<li>Se verifica si la cantidad de pasajeros total alcanzó la máxima permitida.</li>
								<li>Se guarda el atributo.</li>
							</ol>
							<img src="./files/thingsboard/rule_fullbus.png" style="width:60%;height:50%" />
							<p><br></p>								

							<h3 id="rule_7" style="border:3px; border-style:solid; border-color:#2f3647; padding: 1em;; text-align:center">Doors rule</h4>
							<p>Nombre de la rulechain: BondIoT-ESP8266-Passengers_Doors</p>
							<p>El propósito de esta rule chain es únicamente guardar en un atributo la cantidad de pasajeros según las puertas que llega por telemetría en el campo doors.</p>

							<h3 id="rule_8" style="border:3px; border-style:solid; border-color:#2f3647; padding: 1em;; text-align:center">Asset rule</h4>
							<p>Nombre de la rulechain: BondIoT-ESP8266-Asset_Doors</p>
							<p>Esta rule chain fue creada para unir en un mismo message los atributos de cantidad de pasajeros del device principal (pasajeros según celda de carga y según puertas) con el atributo de pasajeros según direcciones MAC proventiente del dispositivo que se utiliza como Sniffer.</p>
							<p>Desde acá se llama entonces, teniendo la información agrupada en un mismo mensaje, a la rule chain encargada de ponderar los datos para determinar el número de pasajeros total.</p>

						</section>

					</div>
				</div>
			</section>
		</section>

		<!-- Footer -->
		<section id="footer">
			<div class="inner">
				<p>&copy; All rights reserved. Designed using <a href="http://html5up.net" >HTML5 UP templates. </a>  Página web y contenido administrado por María José. <a href="autoria.html" style="font-weight:bold">Ver declaración de autoría.</a></p>
			</div>
		</section>

		<!-- Scripts -->
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/jquery.scrollex.min.js"></script>
		<script src="assets/js/browser.min.js"></script>
		<script src="assets/js/breakpoints.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>
				
</body>
</html>